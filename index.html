<!DOCTYPE html>
<html lang="ru" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="referrer" content="no-referrer">
    <title>D-42: Ironclad [Omni]</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        bg: 'var(--bg)',
                        card: 'var(--card)',
                        text: 'var(--text)',
                        border: 'var(--border)',
                        secondary: 'var(--secondary)'
                    }
                }
            }
        }
    </script>
    <style>
        :root {
            --bg: #f8fafc;
            --card: #ffffff;
            --text: #0f172a;
            --border: #e2e8f0;
            --secondary: #f1f5f9;
            --primary: #ec4899;
        }
        .dark {
            --bg: #020617;
            --card: #1e293b;
            --text: #e2e8f0;
            --border: #334155;
            --secondary: #0f172a;
            --primary: #ec4899;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: system-ui, -apple-system, sans-serif;
            transition: background-color 0.3s, color 0.3s;
            overscroll-behavior-y: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: var(--secondary); }
        ::-webkit-scrollbar-thumb { background: #be185d; border-radius: 4px; }

        /* Masonry */
        .masonry-grid { column-count: 2; column-gap: 0.8rem; }
        @media (min-width: 640px) { .masonry-grid { column-count: 3; } }
        @media (min-width: 1024px) { .masonry-grid { column-count: 4; } }
        @media (min-width: 1536px) { .masonry-grid { column-count: 5; } }
        .masonry-item { break-inside: avoid; margin-bottom: 0.8rem; }

        /* Card */
        .card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            transform: translateZ(0);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .card:active { transform: scale(0.98); }

        /* Loader */
        .loader {
            /* –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ª–æ–∞–¥–µ—Ä–∞ –≤–Ω–∏–∑—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
            border-top-color: var(--primary);
            -webkit-animation: spinner 0.8s linear infinite;
            animation: spinner 0.8s linear infinite;
        }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* FIX: Ensure heart-active applies fill for SVG and color for text fallback */
        .heart-active { fill: var(--primary); color: var(--primary); stroke: var(--primary); } 

        /* Tags */
        .tag-btn {
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            margin: 2px;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 600;
            cursor: pointer;
            border: 1px solid rgba(128,128,128,0.2);
            transition: filter 0.2s;
            white-space: nowrap;
        }
        .tag-character { background: #064e3b; color: #6ee7b7; border-color: #059669; }
        .tag-copyright { background: #4c1d95; color: #c4b5fd; border-color: #7c3aed; }
        .tag-artist { 
            background: #881337; 
            color: #fda4af; 
            border-color: #e11d48; 
            font-size: 0.8rem; 
            font-weight: 700;
        }
        .tag-general { background: var(--secondary); color: var(--text); border-color: var(--border); }

        /* Modal */
        #modal { background-color: rgba(0, 0, 0, 0.98); backdrop-filter: blur(15px); }

        /* Animations & UI */
        #blacklist-ui { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); overflow: hidden; }
        .h-0-imp { height: 0 !important; padding: 0 !important; border: 0 !important; opacity: 0; margin: 0 !important; }
        .big-heart-anim { animation: heartPump 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes heartPump {
            0% { transform: scale(0); opacity: 0; }
            40% { transform: scale(1.5); opacity: 1; }
            100% { transform: scale(1); opacity: 0; }
        }
        .hd-active { background-color: var(--primary) !important; color: white !important; border-color: var(--primary) !important; box-shadow: 0 0 15px rgba(236, 72, 153, 0.4); }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–∫—Ä–æ–ª–ª–∞ –ø–æ—Ö–æ–∂–∏—Ö –ø–æ—Å—Ç–æ–≤ */
        #similar-posts-grid::-webkit-scrollbar { height: 4px; }
        #similar-posts-grid::-webkit-scrollbar-thumb { background: #be185d; border-radius: 2px; }
        
        /* –°–æ–æ–±—â–µ–Ω–∏–µ –æ —Å—Ç–∞—Ç—É—Å–µ */
        #status-message { transition: opacity 0.3s, transform 0.3s; }
        
        /* --- CUSTOM VIDEO PLAYER STYLES --- */
        .video-player-container {
            position: relative;
            width: 100%;
            height: auto;
            max-height: 90vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #000;
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
        }
        .video-player-container video {
            display: block;
            width: 100%;
            height: auto;
            max-height: 90vh;
            object-fit: contain;
        }
        .video-controls-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 50px; /* Base height */
            background: linear-gradient(to top, rgba(0,0,0,0.8), rgba(0,0,0,0));
            padding: 8px 10px;
            opacity: 0;
            transition: opacity 0.3s ease;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            gap: 4px;
        }
        .video-player-container:hover .video-controls-overlay { opacity: 1; }
        
        /* Controls Row */
        .controls-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Seeker (Progress Bar) */
        .seeker-container {
            height: 15px; /* Enough for comfortable tap on mobile */
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: 10;
            cursor: pointer;
            padding: 4px 0;
            background-color: transparent;
        }
        .seeker-bar {
            position: relative;
            height: 3px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 1.5px;
            transition: height 0.1s;
        }
        .seeker-bar:hover { height: 5px; }
        .seeker-progress {
            height: 100%;
            width: 0%;
            background: var(--primary);
            border-radius: 1.5px;
            position: absolute;
            top: 0;
            left: 0;
        }
        .seeker-progress::after {
            content: '';
            position: absolute;
            right: -6px;
            top: 50%;
            transform: translateY(-50%);
            width: 12px;
            height: 12px;
            background: var(--primary);
            border-radius: 50%;
            display: none; /* Only show on hover/active */
        }
        .seeker-container:hover .seeker-progress::after { display: block; }
        
        /* Custom Play Button (Center) */
        .play-center-btn {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.5);
            border-radius: 50%;
            padding: 10px;
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
        }
        .video-paused .play-center-btn {
            opacity: 1;
            pointer-events: auto;
        }
        .video-paused .video-controls-overlay {
             opacity: 1;
        }
        
        /* Fix for touch on seeker bar */
        .seeker-container { touch-action: none; }

    </style>
</head>
<body>

    <!-- Header -->
    <div class="sticky top-0 z-40 bg-card/95 border-b border-border p-2 shadow-xl backdrop-blur-md transition-colors duration-300">
        <div class="max-w-[1800px] mx-auto flex flex-col gap-2">
            <!-- Top Row -->
            <div class="flex justify-between items-center">
                <h1 class="text-lg md:text-xl font-black text-pink-600 flex items-center gap-2 tracking-tighter">
                    <i data-lucide="zap"></i> D-42 OMNI
                </h1>
                <div class="flex gap-2">
                     <button onclick="toggleTheme()" class="p-2 rounded-full bg-secondary text-text border border-border hover:bg-pink-600 hover:text-white transition">
                        <i data-lucide="moon" id="theme-icon" class="w-4 h-4"></i>
                     </button>
                     <!-- –ö–Ω–æ–ø–∫–∞ –ò–∑–±—Ä–∞–Ω–Ω–æ–µ -->
                     <button onclick="setView('fav')" id="nav-fav" class="p-2 rounded-full bg-secondary text-text border border-border hover:bg-pink-600 hover:text-white transition relative">
                        <i data-lucide="heart" class="w-4 h-4"></i>
                        <span id="fav-count" class="absolute -top-1 -right-1 bg-pink-500 text-white text-[9px] w-4 h-4 flex items-center justify-center rounded-full">0</span>
                     </button>
                </div>
            </div>

            <!-- Controls -->
            <div id="main-controls" class="flex flex-col gap-2 w-full">
                <div class="flex gap-2">
                    <div class="relative flex-grow">
                        <input type="text" id="searchInput" placeholder="–¢–µ–≥–∏..." 
                               class="w-full bg-secondary border border-border text-text py-2.5 pl-9 pr-3 rounded-lg focus:ring-1 focus:ring-pink-500 outline-none text-sm transition-colors"
                               onkeydown="if(event.key==='Enter') startNewSearch()">
                        <i data-lucide="search" class="absolute left-3 top-3 text-slate-400 w-4 h-4"></i>
                    </div>
                    <button onclick="startNewSearch()" id="searchBtn" class="bg-pink-600 hover:bg-pink-500 text-white font-bold px-4 rounded-lg shadow-lg transition active:scale-95 text-sm">
                        <i data-lucide="search" class="w-4 h-4"></i>
                    </button>
                </div>
                
                <div class="flex gap-2 overflow-x-auto pb-1 no-scrollbar">
                    <select id="typeSelect" class="bg-secondary border border-border text-text text-xs py-2 px-2 rounded-lg outline-none cursor-pointer flex-shrink-0">
                        <option value="all">–í—Å–µ</option>
                        <option value="image">–§–æ—Ç–æ</option>
                        <option value="video">–í–∏–¥–µ–æ</option>
                    </select>
                    <!-- –ö–Ω–æ–ø–∫–∞: –î–æ–±–∞–≤–∏—Ç—å –≤—Å–µ –≤ –ò–∑–±—Ä–∞–Ω–Ω–æ–µ -->
                    <button onclick="addAllToFav()" class="bg-pink-600/10 text-pink-500 hover:bg-pink-600 hover:text-white py-2 px-3 rounded-lg border border-pink-600/30 transition flex-shrink-0 flex items-center gap-1 font-bold text-xs" title="–î–æ–±–∞–≤–∏—Ç—å –≤—Å–µ —Ç–µ–∫—É—â–∏–µ –ø–æ—Å—Ç—ã –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ">
                        <i data-lucide="heart" class="w-3 h-3 fill-pink-500"></i> –í –ò–∑–±—Ä–∞–Ω–Ω–æ–µ
                    </button>
                    <!-- –ö–Ω–æ–ø–∫–∞ Blacklist -->
                    <button onclick="toggleBlacklistUI()" id="btn-blacklist" class="bg-secondary text-text py-2 px-3 rounded-lg border border-border transition flex-shrink-0"><i data-lucide="shield-alert" class="w-4 h-4"></i></button>
                    <button onclick="doLucky()" class="bg-purple-900/40 text-purple-400 py-2 px-3 rounded-lg border border-purple-800 transition flex-shrink-0"><i data-lucide="dice-5" class="w-4 h-4"></i></button>
                </div>

                <!-- Blacklist UI. onchange –≤—ã–∑—ã–≤–∞–µ—Ç saveBlacklist() –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ Firebase -->
                <div id="blacklist-ui" class="h-0-imp bg-red-500/10 border border-red-500/20 rounded-lg flex items-center gap-2 px-3">
                    <span class="text-red-500 text-xs font-bold whitespace-nowrap">‚õî BAN:</span>
                    <input type="text" id="blacklistInput" placeholder="—Ç–µ–≥1 —Ç–µ–≥2..." class="w-full bg-transparent border-none text-red-400 placeholder-red-400/50 focus:ring-0 outline-none py-2 text-xs" onchange="saveBlacklist()">
                </div>
            </div>
            
            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è —Ä–µ–∂–∏–º–∞ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ (—Ç–µ–ø–µ—Ä—å –æ–±—â–∏–π) -->
            <div id="fav-header" class="hidden flex justify-between items-center w-full pb-2">
                <h2 class="text-lg font-bold text-text"></h2>
                <button onclick="setView('search')" class="text-xs bg-secondary px-3 py-1 rounded text-text">–ù–∞–∑–∞–¥</button>
            </div>
            
            <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –æ —Å—Ç–∞—Ç—É—Å–µ (–¥–ª—è –æ—à–∏–±–æ–∫ –∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏) -->
            <div id="status-message" class="hidden text-center text-sm p-1.5 rounded-lg font-medium text-white bg-red-500/90"></div>
        </div>
    </div>

    <!-- Grid -->
    <div class="max-w-[1920px] mx-auto p-3 min-h-screen pb-20">
        <div id="status" class="hidden text-center text-slate-500 text-sm mb-4"></div>
        
        <!-- Main Grid (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∏ –¥–ª—è –ø–æ–∏—Å–∫–∞, –∏ –¥–ª—è –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ) -->
        <div id="grid" class="masonry-grid"></div>
        
        <div id="bottom-loader" class="hidden flex justify-center py-8"><div class="loader border-4 border-pink-600 h-8 w-8 rounded-full"></div></div>
        <div id="empty-state" class="hidden flex flex-col items-center justify-center mt-20 opacity-50">
            <i data-lucide="ghost" class="w-20 h-20 mb-4 text-slate-500"></i>
            <p class="text-slate-500">–ü—É—Å—Ç–æ...</p>
        </div>
        
        <!-- UI –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è UID (–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –º–Ω–æ–≥–æ–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π) -->
        <div class="fixed bottom-0 left-0 right-0 p-2 bg-card/90 border-t border-border text-center text-[10px] text-slate-500 z-50">
             User ID: <span id="user-id-display">Initializing...</span>
        </div>
    </div>

    <!-- MODAL -->
    <div id="modal" class="fixed inset-0 z-[9999] hidden flex flex-col outline-none overflow-hidden" tabindex="-1">
        <div class="absolute top-0 left-0 w-full p-3 flex justify-between items-start z-[100] pointer-events-none bg-gradient-to-b from-black/80 to-transparent">
            <button onclick="toggleHD()" id="hd-btn" class="pointer-events-auto px-3 py-1.5 bg-black/40 text-white font-bold text-[10px] rounded border border-white/10 backdrop-blur shadow-md">HD OFF</button>
            <button onclick="closeModal()" class="pointer-events-auto p-2 bg-black/40 hover:bg-red-600/80 rounded-full text-white backdrop-blur border border-white/10 shadow-md">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>
        <div class="w-full h-full overflow-y-auto overflow-x-hidden" id="modal-scroll-container">
            <div class="min-h-full flex flex-col items-center pt-0 pb-10">
                <div id="swipe-container" class="relative w-full min-h-[50vh] bg-black/20 flex flex-col justify-center items-center mb-0 select-none touch-pan-y">
                    <div id="like-overlay" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 pointer-events-none z-50 hidden">
                        <i data-lucide="heart" class="w-32 h-32 fill-pink-600 text-pink-600 drop-shadow-2xl"></i>
                    </div>
                    <!-- –ó–¥–µ—Å—å –±—É–¥–µ—Ç –∫–æ–Ω—Ç–µ–Ω—Ç (–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–ª–∏ –∫–∞—Å—Ç–æ–º–Ω—ã–π –ø–ª–µ–µ—Ä) -->
                    <div id="media-content" class="w-full flex justify-center relative"></div>
                </div>
                <div class="w-full max-w-5xl px-3 animate-fade-in-up z-10 -mt-4">
                    <div class="bg-slate-900 border border-slate-800 rounded-xl p-4 shadow-2xl relative text-slate-200">
                        
                        <!-- –ë–õ–û–ö –ú–ï–¢–ê–î–ê–ù–ù–´–• –ò –î–ï–ô–°–¢–í–ò–ô -->
                        <div class="flex flex-col items-start mb-4 pb-3 border-b border-slate-800">
                            <div class="flex justify-between items-center w-full">
                                <div class="flex flex-col">
                                    <span class="bg-slate-800 px-2 py-0.5 rounded text-[10px] text-green-400 font-bold w-max mb-1" id="meta-score">Score: 0</span>
                                    <span class="text-slate-500 text-[10px] font-mono">ID: <span id="meta-id">...</span></span>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="toggleFavCurrent()" class="w-10 h-10 rounded-lg bg-slate-800 border border-slate-700 flex items-center justify-center active:scale-95 transition">
                                        <i data-lucide="heart" id="modal-heart" class="w-5 h-5 transition-colors"></i>
                                    </button>
                                    <a id="modal-dl" href="#" target="_blank" class="flex items-center gap-2 px-4 h-10 rounded-lg bg-pink-600 hover:bg-pink-500 text-white text-xs font-bold shadow-lg shadow-pink-600/20 active:scale-95 transition">
                                        <i data-lucide="download" class="w-4 h-4"></i> Save
                                    </a>
                                </div>
                            </div>
                            <!-- –†–ê–ó–î–ï–õ –ê–í–¢–û–†–ê -->
                            <div id="author-container" class="mt-3 w-full">
                                <h4 class="text-[9px] uppercase font-bold text-slate-500 mb-1 flex items-center gap-1">
                                    <i data-lucide="brush" class="w-3 h-3"></i> Author / Artist
                                </h4>
                                <div id="author-tags">
                                    <span class="text-slate-500 italic text-sm">N/A (–¢–µ–≥ "artist:..." –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –∏—Å—Ç–æ—á–Ω–∏–∫–µ)</span>
                                </div>
                            </div>
                        </div>
                        
                        <div id="tags-container" class="space-y-3"></div>
                        
                        <!-- –†–ê–ó–î–ï–õ: –ü–æ—Ö–æ–∂–∏–µ –ø–æ—Å—Ç—ã -->
                        <div id="similar-posts-container" class="mt-6 pt-4 border-t border-slate-800">
                            <h3 class="text-sm md:text-md font-bold text-pink-400 mb-3 flex items-center gap-2">
                                <i data-lucide="infinity" class="w-4 h-4"></i> –ü–æ—Ö–æ–∂–∏–µ –ø–æ—Å—Ç—ã
                            </h3>
                            <div id="similar-posts-grid" class="flex overflow-x-auto gap-3 pb-2">
                                <!-- –ó–¥–µ—Å—å –±—É–¥—É—Ç –º–∏–Ω–∏-–∫–∞—Ä—Ç–æ—á–∫–∏ -->
                                <div id="similar-loader" class="flex justify-center items-center w-full min-h-[100px] text-slate-500">
                                    <div class="loader border-2 border-pink-400 h-6 w-6 rounded-full"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, deleteDoc, onSnapshot, collection, query, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ Firebase (–±—É–¥—É—Ç –¥–æ—Å—Ç—É–ø–Ω—ã –≤ window)
        window.firebaseApp = null;
        window.db = null;
        window.auth = null;
        window.appId = null;
        window.currentUserId = null;
        window.isAuthReady = false;
        
        // VITAL FIX: –î–µ–ª–∞–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ Firestore –≥–ª–æ–±–∞–ª—å–Ω–æ –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏
        window.doc = doc;
        window.setDoc = setDoc;
        window.deleteDoc = deleteDoc;
        window.onSnapshot = onSnapshot; 
        window.collection = collection;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase –∏ –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
        async function initializeFirebase() {
            try {
                setLogLevel('Debug');
                
                window.appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                if (Object.keys(firebaseConfig).length === 0) throw new Error("Firebase config is missing.");

                window.firebaseApp = initializeApp(firebaseConfig);
                window.db = getFirestore(window.firebaseApp);
                window.auth = getAuth(window.firebaseApp);
                
                await setPersistence(window.auth, browserLocalPersistence);

                onAuthStateChanged(window.auth, (user) => {
                    window.currentUserId = user ? user.uid : crypto.randomUUID();
                    window.isAuthReady = true; 
                    document.getElementById('user-id-display').innerText = window.currentUserId;
                    console.log("‚úÖ Firebase Auth State Changed. User ID:", window.currentUserId);
                    
                    if (user) {
                        // –ó–∞–ø—É—Å–∫ —Å–ª—É—à–∞—Ç–µ–ª–µ–π —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
                        window.startFavoritesListener();
                        window.startBlacklistListener(); 
                    }
                    showMessage(`‚úÖ –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞. ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${window.currentUserId.substring(0, 8)}...`, 'green');
                });

                if (initialAuthToken) {
                    await signInWithCustomToken(window.auth, initialAuthToken);
                } else {
                    await signInAnonymously(window.auth);
                }

            } catch (error) {
                console.error("‚ùå Firebase Initialization Error:", error);
                document.getElementById('user-id-display').innerText = `Error: ${error.message}`;
                showMessage(`‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase: ${error.message}`, 'red');
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–≤–æ–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏–π —Å—Ç–∞—Ç—É—Å–∞
        function showMessage(text, type = 'red') {
            const statusEl = document.getElementById('status-message');
            statusEl.innerText = text;
            statusEl.className = `fixed top-0 left-1/2 -translate-x-1/2 mt-2 p-2 rounded-lg shadow-xl font-medium z-[100] ${type === 'green' ? 'bg-green-500/90' : 'bg-red-500/90'} text-white text-sm`;
            statusEl.classList.remove('hidden');
            setTimeout(() => {
                statusEl.classList.add('hidden');
            }, 4000);
        }

        window.showMessage = showMessage; 
        initializeFirebase();
    </script>

    <script>
        // --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ---
        const API_KEY = 'd82f6db279ce94313e629e791533d456a4309dfeb528ddab6eee4b7472156f0def07ebfd3e64b9dddbf0d3b78f227ba8a5f386533ef1ccb1377d8a97481811dc';
        const USER_ID = '5255009';
        // –ë–∞–∑–æ–≤—ã–π URL —Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π.
        const BASE_URL = `https://api.rule34.xxx/index.php?page=dapi&s=post&q=index&api_key=${API_KEY}&user_id=${USER_ID}`;
        
        // --- –ì–õ–û–ë–ê–õ–¨–ù–û–ï –°–û–°–¢–û–Ø–ù–ò–ï ---
        let state = {
            posts: [], 
            cachedSearchResults: [], 
            favorites: [], 
            blacklistTags: [], 
            currentIndex: 0,
            viewMode: 'search',
            page: 0,
            isLoading: false,
            hasMore: true,
            isHD: false,
            isLucky: false,
            isDark: localStorage.getItem('d42_theme') !== 'light',
            similarPosts: []
        };
        
        // --- –§–£–ù–ö–¶–ò–ò FIREBASE ---
        window.startBlacklistListener = () => {
            const { db, currentUserId, appId } = window;
            if (!db || !currentUserId || !appId) return;

            console.log(`Starting Firestore blacklist listener for user: ${currentUserId}`);
            const blacklistDocRef = window.doc(window.db, `artifacts/${window.appId}/users/${window.currentUserId}/config`, 'blacklist');
            
            window.onSnapshot(blacklistDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const tagsArray = Array.isArray(data.tags) ? data.tags : (data.tags || '').split(/\s+/).filter(t => t.length > 0);
                    state.blacklistTags = tagsArray;
                    document.getElementById('blacklistInput').value = tagsArray.join(' ');
                    console.log(`‚úÖ Blacklist updated: ${tagsArray.length} tags.`);
                } else {
                    state.blacklistTags = [];
                    document.getElementById('blacklistInput').value = '';
                    console.log("Blacklist document does not exist, initializing empty.");
                }
            }, (error) => {
                console.error("‚ùå Error listening to blacklist:", error);
                window.showMessage(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ Blacklist: ${error.message}`, 'red');
            });
        };
        
        function saveBlacklist() {
            const { db, currentUserId, appId, isAuthReady } = window;
            const input = document.getElementById('blacklistInput').value.trim();
            const tagsArray = input.split(/\s+/).filter(t => t.length > 0);

            if (!isAuthReady || !db || !currentUserId) {
                window.showMessage("–ü–æ–¥–æ–∂–¥–∏—Ç–µ, Firebase –Ω–µ –≥–æ—Ç–æ–≤ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è Blacklist.", 'red');
                return;
            }

            const blacklistDocRef = window.doc(window.db, `artifacts/${window.appId}/users/${window.currentUserId}/config`, 'blacklist');

            try {
                window.setDoc(blacklistDocRef, { 
                    tags: tagsArray, 
                    updatedAt: Date.now() 
                }, { merge: true });
                window.showMessage(`‚úÖ Blacklist —Å–æ—Ö—Ä–∞–Ω–µ–Ω: ${tagsArray.length} —Ç–µ–≥–æ–≤.`, 'green');
            } catch (error) {
                console.error("‚ùå Error saving blacklist:", error);
                window.showMessage(`‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è Blacklist: ${error.message}`, 'red');
            }
        }
        
        window.startFavoritesListener = () => {
            const { db, currentUserId, appId } = window;
            if (!db || !currentUserId || !appId) return;

            console.log(`Starting Firestore listener for user: ${currentUserId}`);
            const favsRef = window.collection(window.db, `artifacts/${window.appId}/users/${window.currentUserId}/favorites`);
            
            window.onSnapshot(favsRef, (snapshot) => {
                state.favorites = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                })).sort((a, b) => b.timestamp - a.timestamp);
                
                updateFavCount();
                
                if (state.viewMode === 'fav') {
                    state.posts = [...state.favorites]; 
                    document.getElementById('grid').innerHTML = ''; 
                    renderBatch(state.posts, 0); 
                    document.getElementById('empty-state').classList.toggle('hidden', state.posts.length > 0);
                }
                updateGridHearts();
            }, (error) => {
                console.error("‚ùå Error listening to favorites:", error);
                window.showMessage(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ: ${error.message}`, 'red');
            });
        };
        
        async function toggleFav(post) {
            console.log("Attempting toggleFav for post:", post.id);
            if (!window.isAuthReady || !window.db || !window.currentUserId) {
                window.showMessage("–ü–æ–¥–æ–∂–¥–∏—Ç–µ, Firebase –Ω–µ –≥–æ—Ç–æ–≤. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —á–µ—Ä–µ–∑ —Å–µ–∫—É–Ω–¥—É.", 'red');
                return;
            }

            const isFav = state.favorites.some(f => f.id === post.id);
            const favDocRef = window.doc(window.db, `artifacts/${window.appId}/users/${window.currentUserId}/favorites`, post.id);

            try {
                if (isFav) {
                    await window.deleteDoc(favDocRef);
                    console.log(`‚úÖ Removed post ${post.id} from favorites.`);
                    window.showMessage(`üíî –£–¥–∞–ª–µ–Ω–æ: #${post.id}`, 'green');
                } else {
                    const dataToSave = {
                        id: post.id,
                        fileUrl: post.fileUrl,
                        sampleUrl: post.sampleUrl,
                        gridUrl: post.gridUrl,
                        type: post.type,
                        score: post.score,
                        tags: post.tags,
                        timestamp: Date.now() 
                    };
                    await window.setDoc(favDocRef, dataToSave);
                    console.log(`‚úÖ Added post ${post.id} to favorites.`);
                    window.showMessage(`‚ù§Ô∏è –î–æ–±–∞–≤–ª–µ–Ω–æ: #${post.id}`, 'green');
                }
                updateModalHeart(post.id, !isFav);
            } catch (error) {
                console.error("‚ùå Error toggling favorite status:", error);
                window.showMessage(`‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ${error.message}. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å.`, 'red');
            }
        }
        
        function updateFavCount() { document.getElementById('fav-count').innerText = state.favorites.length; }

        function updateGridHearts() {
             document.querySelectorAll('#grid .masonry-item').forEach(item => {
                const button = item.querySelector('button[id^="grid-btn-"]');
                if (!button) return;
                const postId = button.id.replace('grid-btn-', '');
                const icon = document.getElementById(`fav-${postId}`);
                const isFav = state.favorites.some(f => f.id === postId);
                if (icon) {
                    icon.classList.toggle('heart-active', isFav);
                    icon.classList.toggle('text-white', !isFav);
                }
            });
        }
        
        // --- –ö–û–ù–ï–¶ FIREBASE –§–£–ù–ö–¶–ò–ô ---


        // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---
        lucide.createIcons();
        applyTheme();

        // --- –î–í–ò–ñ–û–ö –¢–ï–ú–´ ---
        function toggleTheme() {
            state.isDark = !state.isDark;
            localStorage.setItem('d42_theme', state.isDark ? 'dark' : 'light');
            applyTheme();
        }
        function applyTheme() {
            const html = document.documentElement;
            const icon = document.getElementById('theme-icon');
            if (state.isDark) {
                html.classList.add('dark');
                icon.setAttribute('data-lucide', 'moon');
            } else {
                html.classList.remove('dark');
                icon.setAttribute('data-lucide', 'sun');
            }
            lucide.createIcons();
        }

        // --- –û–°–ù–û–í–ù–û–ô –ü–û–ò–°–ö ---
        function startNewSearch(overrideTags = null, isLuckyMode = false) {
            state.page = isLuckyMode ? 0 : Math.floor(Math.random() * 30);
            state.posts = [];
            state.cachedSearchResults = [];
            state.hasMore = true;
            state.isLoading = false;
            state.isLucky = isLuckyMode;
            document.getElementById('grid').innerHTML = '';
            document.getElementById('empty-state').classList.add('hidden');
            
            if (overrideTags) document.getElementById('searchInput').value = overrideTags;
            
            fetchPosts();
        }

        async function fetchPosts() {
            if (state.isLoading || !state.hasMore || state.viewMode === 'fav') return;
            
            const input = document.getElementById('searchInput');
            
            const blacklistTags = state.blacklistTags;
            
            let tags = input.value.trim();
            if (!tags && state.viewMode === 'search') {
                tags = 'original'; 
                input.value = tags;
            }

            state.isLoading = true;
            document.getElementById('bottom-loader').classList.remove('hidden');
            
            let apiTags = tags.replace(/\s+/g, '+');
            
            if(blacklistTags.length > 0) {
                 blacklistTags.forEach(t => apiTags += `+-${t}`);
            }
            
            if(state.isLucky) apiTags += '+sort:random';

            const type = document.getElementById('typeSelect').value;
            if (type === 'video') apiTags += '+video';
            else if (type === 'image') apiTags += '+-video';

            const url = `${BASE_URL}&limit=40&tags=${apiTags}&pid=${state.page}`;
            console.log("Fetching URL:", url);

            try {
                const res = await fetch(url);
                if (!res.ok) { throw new Error(`HTTP error! status: ${res.status}`); }
                const text = await res.text();
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(text, "text/xml"); 
                const errorElement = xmlDoc.getElementsByTagName('error')[0];
                if (errorElement) { throw new Error(`API Error: ${errorElement.textContent}`); }
                
                const posts = xmlDoc.getElementsByTagName('post');
                
                if (posts.length === 0) {
                    state.hasMore = false;
                    if(state.posts.length === 0) document.getElementById('empty-state').classList.remove('hidden');
                } else {
                    const newPosts = Array.from(posts).map(p => {
                        const fileUrl = p.getAttribute('file_url');
                        const ext = fileUrl.split('.').pop().toLowerCase();
                        const isVideo = ext === 'mp4' || ext === 'webm';
                        const sampleUrl = p.getAttribute('sample_url') || fileUrl;
                        const previewUrl = p.getAttribute('preview_url');
                        let gridImage = sampleUrl;
                        if(isVideo) gridImage = previewUrl || sampleUrl; 

                        return {
                            id: p.getAttribute('id'),
                            fileUrl: fileUrl,
                            sampleUrl: sampleUrl,
                            gridUrl: gridImage, 
                            type: isVideo ? 'video' : 'image',
                            score: p.getAttribute('score'),
                            tags: p.getAttribute('tags')
                        };
                    }).filter(p => {
                        if (type === 'video' && p.type !== 'video') return false;
                        if (type === 'image' && p.type === 'video') return false;
                        return true;
                    });

                    const startIndex = state.posts.length;
                    state.posts = [...state.posts, ...newPosts];
                    state.cachedSearchResults = [...state.posts];
                    renderBatch(newPosts, startIndex);
                    state.page++;
                }
            } catch (e) { 
                console.error("‚ùå Search failed:", e); 
                window.showMessage(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞: ${e.message}. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–µ–≥–∏ –∏–ª–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.`, 'red');
            } 
            finally {
                state.isLoading = false;
                document.getElementById('bottom-loader').classList.add('hidden');
            }
        }

        function renderBatch(batch, startIndex) {
            const grid = document.getElementById('grid');
            batch.forEach((post, i) => {
                const globalIndex = startIndex + i;
                const isFav = state.favorites.some(f => f.id === post.id);
                const el = document.createElement('div');
                el.className = 'masonry-item card group animate-fade-in';
                el.onclick = () => openModal(globalIndex); 

                const imgTag = `<img src="${post.gridUrl}" onerror="this.onerror=null;this.src='https://placehold.co/300x400/1e293b/94a3b8?text=Load+Error'" class="w-full h-auto bg-slate-800 block" loading="lazy" style="display:block;">`;
                let mediaHtml = post.type === 'video' ? `
                        <div class="relative w-full">${imgTag}
                            <div class="absolute inset-0 flex items-center justify-center">
                                <div class="bg-black/60 rounded-full p-1.5 backdrop-blur-sm border border-white/20"><i data-lucide="play" class="w-4 h-4 text-white fill-white"></i></div>
                            </div>
                            <div class="absolute top-1 left-1 bg-pink-600 text-white text-[8px] font-bold px-1.5 py-0.5 rounded shadow">VIDEO</div>
                        </div>` : imgTag;

                el.innerHTML = `
                    ${mediaHtml}
                    <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition duration-300 flex flex-col justify-end p-2 pointer-events-none">
                        <span class="text-green-400 font-bold text-[10px]">${post.score}</span>
                    </div>
                    <button onclick="toggleFavFromGrid(event, '${post.id}')" id="grid-btn-${post.id}" class="absolute top-1 right-1 p-1.5 bg-black/40 hover:bg-slate-700 rounded-full transition opacity-0 group-hover:opacity-100 pointer-events-auto backdrop-blur-md">
                         <i data-lucide="heart" class="w-3 h-3 ${isFav ? 'heart-active' : 'text-white'}" id="fav-${post.id}"></i>
                    </button>`;
                grid.appendChild(el);
            });
            lucide.createIcons();
        }

        // --- –§–£–ù–ö–¶–ò–ò –ú–û–î–ê–õ–¨–ù–û–ì–û –û–ö–ù–ê –ò –ü–†–ï–õ–û–ê–î–ò–ù–ì–ê ---
        
        function preloadMedia(post) {
            if (!post) return;
            const url = post.fileUrl; 
            
            if (document.querySelector(`img[src="${url}"]`) || document.querySelector(`video[src="${url}"]`)) return;

            if (post.type === 'image') {
                const img = new Image();
                img.src = url;
                img.style.display = 'none';
                img.onerror = () => console.log(`[Preload] Failed to load ${url}`);
                document.body.appendChild(img);
                img.onload = () => setTimeout(() => img.remove(), 100); 

            } else if (post.type === 'video') {
                const video = document.createElement('video');
                video.src = url;
                video.preload = 'auto';
                video.style.display = 'none';
                document.body.appendChild(video);
                setTimeout(() => video.remove(), 5000); 
            }
        }
        
        function openModal(index, source = 'main') {
            state.isHD = false;
            document.getElementById('hd-btn').classList.remove('hd-active'); 
            document.getElementById('hd-btn').innerText = 'HD OFF';
            
            if (source === 'similar') {
                const similarPost = state.similarPosts[index];
                const existingIndex = state.posts.findIndex(p => p.id === similarPost.id);
                if (existingIndex !== -1) {
                    state.currentIndex = existingIndex;
                } else {
                    state.posts.push(similarPost);
                    state.currentIndex = state.posts.length - 1;
                    if (state.viewMode === 'search') {
                        state.cachedSearchResults = [...state.posts];
                    }
                }
            } else {
                state.currentIndex = index;
            }

            const modal = document.getElementById('modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            document.body.style.overflow = 'hidden';
            loadModalContent();
        }

        function loadModalContent() {
            const currentPost = state.posts[state.currentIndex];
            const container = document.getElementById('media-content');
            
            document.getElementById('modal-dl').href = currentPost.fileUrl;
            document.getElementById('meta-id').innerText = currentPost.id;
            document.getElementById('meta-score').innerText = `${currentPost.score}`;
            updateModalHeart(currentPost.id); 
            document.getElementById('modal-scroll-container').scrollTop = 0;
            document.getElementById('similar-posts-grid').innerHTML = '<div id="similar-loader" class="flex justify-center items-center w-full min-h-[100px] text-slate-500"><div class="loader border-2 border-pink-400 h-6 w-6 rounded-full"></div></div>';
            
            container.innerHTML = '';
            
            const src = state.isHD ? currentPost.fileUrl : currentPost.sampleUrl;
            
            if (currentPost.type === 'video') {
                // --- CUSTOM VIDEO PLAYER ---
                renderVideoPlayer(currentPost);
                
            } else { // Image
                const img = new Image();
                img.src = src;
                img.style.cssText = 'width: 100%; height: auto; max-height: 90vh; object-fit: contain;';
                img.className = 'rounded shadow-2xl bg-slate-900';
                img.draggable = false;
                img.onerror = function() {
                    this.src='https://placehold.co/800x600/1e293b/94a3b8?text=Load+Error';
                }
                container.appendChild(img);
            }

            setupTouch();
            
            const nextIndex = (state.currentIndex + 1) % state.posts.length;
            const prevIndex = (state.currentIndex - 1 + state.posts.length) % state.posts.length;
            
            preloadMedia(state.posts[nextIndex]);
            preloadMedia(state.posts[prevIndex]);

            renderAuthorInfo(currentPost.tags); 
            renderTags(currentPost.tags);
            const similarTags = getRandomTags(currentPost.tags);
            fetchSimilarPosts(currentPost, similarTags);
        }
        
        // --- CUSTOM VIDEO PLAYER LOGIC ---
        function formatTime(seconds) {
            const date = new Date(null);
            date.setSeconds(seconds);
            return date.toISOString().substring(11, 19).replace(/^0(?:0:0?)?/, ''); // Removes hours if 00:00:xx
        }
        
        function toggleFullscreen(videoContainer) {
            if (document.fullscreenElement) {
                document.exitFullscreen();
            } else {
                if (videoContainer.requestFullscreen) {
                    videoContainer.requestFullscreen();
                } else if (videoContainer.webkitRequestFullscreen) { /* Safari */
                    videoContainer.webkitRequestFullscreen();
                } else if (videoContainer.msRequestFullscreen) { /* IE11 */
                    videoContainer.msRequestFullscreen();
                }
            }
            // Re-render lucide icons after fullscreen transition might be necessary
            setTimeout(() => lucide.createIcons(), 300);
        }

        function setupCustomPlayer(post) {
            const containerEl = document.getElementById(`video-container-${post.id}`);
            const videoEl = containerEl.querySelector('video');
            const playPauseBtn = containerEl.querySelector('#play-pause-btn');
            const seekerBar = containerEl.querySelector('.seeker-bar');
            const seekerProgress = containerEl.querySelector('.seeker-progress');
            const timeDisplay = containerEl.querySelector('#time-display');
            const centerPlayBtn = containerEl.querySelector('#center-play-btn');
            const fullscreenBtn = containerEl.querySelector('#fullscreen-btn');
            
            // 1. Loading/Metadata
            videoEl.onloadedmetadata = () => {
                timeDisplay.innerText = `0:00 / ${formatTime(videoEl.duration)}`;
                containerEl.classList.add('video-paused'); // Start paused
                videoEl.play(); // Attempt autoplay
            };
            
            // 2. Play/Pause
            const togglePlay = () => {
                if (videoEl.paused || videoEl.ended) {
                    videoEl.play();
                } else {
                    videoEl.pause();
                }
            };
            playPauseBtn.onclick = togglePlay;
            centerPlayBtn.onclick = togglePlay;
            videoEl.onclick = togglePlay;

            videoEl.onplay = () => {
                playPauseBtn.querySelector('i').setAttribute('data-lucide', 'pause');
                containerEl.classList.remove('video-paused');
                lucide.createIcons();
            };
            videoEl.onpause = () => {
                playPauseBtn.querySelector('i').setAttribute('data-lucide', 'play');
                containerEl.classList.add('video-paused');
                lucide.createIcons();
            };
            
            // Double click/tap for fullscreen
            containerEl.ondblclick = (e) => {
                e.stopPropagation();
                toggleFullscreen(containerEl);
            };

            // 3. Time Update & Progress
            videoEl.ontimeupdate = () => {
                const currentTime = videoEl.currentTime;
                const duration = videoEl.duration;
                if (!isNaN(duration)) {
                    const progress = (currentTime / duration) * 100;
                    seekerProgress.style.width = `${progress}%`;
                    timeDisplay.innerText = `${formatTime(currentTime)} / ${formatTime(duration)}`;
                }
            };

            // 4. Seeking
            const handleSeek = (e) => {
                const duration = videoEl.duration;
                const rect = seekerBar.getBoundingClientRect();
                let clientX = e.clientX;
                if (e.touches) clientX = e.touches[0].clientX; // Handle touch events

                const clickX = clientX - rect.left;
                const seekToTime = (clickX / rect.width) * duration;
                if (!isNaN(duration)) {
                    videoEl.currentTime = seekToTime;
                }
            };

            seekerBar.parentNode.addEventListener('click', (e) => {
                e.stopPropagation();
                handleSeek(e);
            });
            // Handle touch events on the seeker bar wrapper
            seekerBar.parentNode.addEventListener('touchstart', (e) => {
                e.preventDefault(); // Prevent touch-scrolling the modal
                handleSeek(e);
            }, { passive: false });
            seekerBar.parentNode.addEventListener('touchmove', (e) => {
                e.preventDefault();
                handleSeek(e);
            }, { passive: false });
            
            // 5. Fullscreen
            fullscreenBtn.onclick = () => toggleFullscreen(containerEl);

            // Hide loader on initial load error
            videoEl.onerror = () => {
                console.error("‚ùå Video loading error.");
                window.showMessage("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ—Ñ–∞–π–ª–∞.", 'red');
            };
        }

        function renderVideoPlayer(post) {
            const container = document.getElementById('media-content');
            
            // –ì–ª–∞–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≤–∏–¥–µ–æ –∏ –∫–æ–Ω—Ç—Ä–æ–ª–æ–≤
            const playerContainer = document.createElement('div');
            playerContainer.className = 'video-player-container rounded shadow-2xl';
            playerContainer.id = `video-container-${post.id}`;
            playerContainer.style.maxWidth = '100%'; 

            const videoElement = document.createElement('video');
            videoElement.id = `customVideoPlayer-${post.id}`;
            videoElement.src = post.fileUrl; // Always use high quality for custom player
            videoElement.loop = true;
            videoElement.autoplay = true; 
            videoElement.muted = false; // Start unmuted, user will control
            videoElement.preload = 'metadata';
            videoElement.playsInline = true;

            // –ö–Ω–æ–ø–∫–∞ Play –≤ —Ü–µ–Ω—Ç—Ä–µ (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è, –∫–æ–≥–¥–∞ –≤–∏–¥–µ–æ –Ω–∞ –ø–∞—É–∑–µ)
            const centerPlayButton = `
                <div id="center-play-btn" class="play-center-btn">
                    <i data-lucide="play" class="w-10 h-10 text-white fill-white"></i>
                </div>
            `;
            
            // –ö–∞—Å—Ç–æ–º–Ω—ã–µ –∫–æ–Ω—Ç—Ä–æ–ª—ã
            const controlsOverlay = `
                <div class="video-controls-overlay">
                    
                    <!-- 1. Seeker Bar (–ü—Ä–æ–≥—Ä–µ—Å—Å) -->
                    <div class="seeker-container">
                        <div class="seeker-bar">
                            <div class="seeker-progress"></div>
                        </div>
                    </div>

                    <!-- 2. Controls Row (–ö–Ω–æ–ø–∫–∏) -->
                    <div class="controls-row text-white text-sm">
                        <!-- Play/Pause Button -->
                        <button id="play-pause-btn" class="p-1 rounded-full hover:bg-white/20 transition active:scale-95">
                            <i data-lucide="play" class="w-5 h-5 fill-white"></i>
                        </button>
                        
                        <!-- Time Display -->
                        <span id="time-display" class="font-mono text-xs">0:00 / 0:00</span>
                        
                        <!-- Spacer (–ó–∞–ø–æ–ª–Ω—è–µ—Ç –º–µ—Å—Ç–æ) -->
                        <div class="flex-grow"></div>
                        
                        <!-- Volume/Mute (–ü—Ä–æ—Å—Ç–∞—è –∫–Ω–æ–ø–∫–∞ Mute/Unmute) -->
                        <button onclick="document.getElementById('customVideoPlayer-${post.id}').muted = !document.getElementById('customVideoPlayer-${post.id}').muted;" class="p-1 rounded-full hover:bg-white/20 transition active:scale-95">
                             <i data-lucide="volume-2" class="w-5 h-5"></i>
                        </button>

                        <!-- Fullscreen Button -->
                        <button id="fullscreen-btn" class="p-1 rounded-full hover:bg-white/20 transition active:scale-95">
                            <i data-lucide="maximize" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
            `;
            
            playerContainer.innerHTML = centerPlayButton + controlsOverlay;
            playerContainer.prepend(videoElement); // –î–æ–±–∞–≤–ª—è–µ–º –≤–∏–¥–µ–æ—ç–ª–µ–º–µ–Ω—Ç –ø–µ—Ä–≤—ã–º
            container.appendChild(playerContainer);

            // –°–æ–∑–¥–∞–µ–º –∏–∫–æ–Ω–∫–∏ lucide
            lucide.createIcons(); 
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ª–æ–≥–∏–∫—É –ø–ª–µ–µ—Ä–∞
            setupCustomPlayer(post);
        }
        // --- –ö–û–ù–ï–¶ CUSTOM VIDEO PLAYER LOGIC ---


        function setupTouch() {
            const area = document.getElementById('swipe-container');
            const newArea = area.cloneNode(true); 
            area.parentNode.replaceChild(newArea, area);
            
            newArea.addEventListener('touchstart', e => touchStartX = e.changedTouches[0].screenX, {passive: true});
            newArea.addEventListener('touchend', e => {
                touchEndX = e.changedTouches[0].screenX;
                if(Math.abs(touchEndX - touchStartX) > 60) nav(touchEndX < touchStartX ? 1 : -1);
                handleDoubleTap();
            });
            newArea.addEventListener('mousedown', e => touchStartX = e.clientX);
            newArea.addEventListener('mouseup', e => {
                touchEndX = e.clientX;
                // Check if the click was within the controls overlay (to prevent seeking from triggering navigation)
                const isClickOnControls = e.target.closest('.video-controls-overlay');
                if(!isClickOnControls && Math.abs(touchEndX - touchStartX) > 60) {
                     nav(touchEndX < touchStartX ? 1 : -1);
                }
                
                if(e.detail === 2) {
                     const isClickOnVideo = e.target.closest('video');
                     if(!isClickOnVideo) triggerDoubleTapLike();
                }
            });
        }

        let lastTap = 0;
        function handleDoubleTap() {
            const now = new Date().getTime();
            if (now - lastTap < 300 && now - lastTap > 0) triggerDoubleTapLike();
            lastTap = now;
        }

        function triggerDoubleTapLike() {
            toggleFavCurrent();
            const ov = document.getElementById('like-overlay');
            ov.classList.remove('hidden');
            ov.classList.add('big-heart-anim');
            setTimeout(() => { ov.classList.remove('big-heart-anim'); ov.classList.add('hidden'); }, 600);
        }

        function closeModal() {
            document.getElementById('modal').classList.add('hidden');
            document.getElementById('modal').classList.remove('flex');
            document.body.style.overflow = '';
            document.getElementById('media-content').innerHTML = ''; 
            state.similarPosts = [];
            // –í—ã—Ö–æ–¥ –∏–∑ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª–∫–∏
            if (document.fullscreenElement) document.exitFullscreen();
        }

        function nav(dir) {
            if (state.posts.length === 0) return;
            
            let next = state.currentIndex + dir;
            
            if (next < 0) next = state.posts.length - 1;
            if (next >= state.posts.length) next = 0;
            
            state.currentIndex = next;
            loadModalContent();
            
            if (state.viewMode === 'search' && state.currentIndex >= state.posts.length - 5) fetchPosts();
        }

        // --- –ê–í–¢–û–† –ò –¢–ï–ì–ò (–Ω–µ–∏–∑–º–µ–Ω–Ω—ã) ---
        function renderAuthorInfo(tagsString) {
            const container = document.getElementById('author-tags');
            const artistTags = tagsString.split(' ').filter(t => t.startsWith('artist:')).map(t => t.replace('artist:', ''));

            if (artistTags.length === 0) {
                container.innerHTML = '<span class="text-slate-500 italic text-sm">N/A (–¢–µ–≥ "artist:..." –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –∏—Å—Ç–æ—á–Ω–∏–∫–µ)</span>';
                return;
            }

            const html = artistTags.map(artist => {
                return `<span onclick="tagSearch('artist:${artist}')" class="tag-btn tag-artist shadow-sm hover:shadow-lg active:scale-[0.98] transition cursor-pointer">
                            <i data-lucide="brush" class="w-3 h-3 inline-block mr-1"></i>
                            ${artist.replace(/_/g, ' ')}
                        </span>`;
            }).join('');

            container.innerHTML = `<div class="flex flex-wrap gap-2">${html}</div>`;
            lucide.createIcons();
        }
        
        function renderTags(tagsString) {
            const container = document.getElementById('tags-container');
            container.innerHTML = '';
            const groups = { character: [], copyright: [], general: [] };
            
            tagsString.split(' ').forEach(tag => {
                if (tag.startsWith('artist:')) return; 
                
                if (tag.startsWith('character:')) groups.character.push(tag.replace('character:', ''));
                else if (tag.startsWith('copyright:')) groups.copyright.push(tag.replace('copyright:', ''));
                else groups.general.push(tag);
            });
            
            let html = '';
            if(groups.copyright.length) html += block('Fandoms', groups.copyright, 'tag-copyright');
            if(groups.character.length) html += block('Characters', groups.character, 'tag-character');
            if(groups.general.length) html += block('Tags (–û–±—â–∏–µ)', groups.general, 'tag-general');
            container.innerHTML = html;
        }
        
        function block(title, tags, cls) {
            return `<div><h4 class="text-[9px] uppercase font-bold text-slate-500 mb-1">${title}</h4>
                    <div class="flex flex-wrap">${tags.map(t => `<span onclick="tagSearch('${t}')" class="tag-btn ${cls} cursor-pointer">${t.replace(/_/g, ' ')}</span>`).join('')}</div></div>`;
        }
        
        function tagSearch(tag) { 
            closeModal(); 
            document.getElementById('searchInput').value = tag.includes(':') ? tag : tag; 
            startNewSearch(tag); 
        }

        // --- –ü–û–•–û–ñ–ò–ï –ü–û–°–¢–´ –ò –ü–†–û–ß–ï–ï (–Ω–µ–∏–∑–º–µ–Ω–Ω—ã) ---
        
        function getRandomTags(tagsString) {
            const allTags = tagsString.split(' ').filter(t => t.length > 0);
            const filterTags = allTags.filter(t => 
                !t.startsWith('rating:') && 
                !t.startsWith('source:') && 
                !t.startsWith('date:') && 
                !t.includes('resolution') &&
                t !== 'high_res' && t !== 'low_res' && t !== 'webm' && t !== 'mp4'
            );

            if (filterTags.length === 0) return [];
            
            const numTags = Math.min(filterTags.length, 3);
            const selectedTags = [];
            const tempArray = [...filterTags];
            
            for (let i = 0; i < numTags; i++) {
                const randomIndex = Math.floor(Math.random() * tempArray.length);
                selectedTags.push(tempArray[randomIndex]);
                tempArray.splice(randomIndex, 1);
            }

            return selectedTags;
        }

        async function fetchSimilarPosts(mainPost, tags) {
            const container = document.getElementById('similar-posts-grid');
            container.innerHTML = `<div id="similar-loader" class="flex justify-center items-center w-full min-h-[100px] text-slate-500">
                                        <div class="loader border-2 border-pink-400 h-6 w-6 rounded-full"></div>
                                   </div>`;

            if (tags.length === 0) {
                container.innerHTML = '<span class="text-slate-500 text-sm">–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–µ–≥–æ–≤ –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ—Ö–æ–∂–∏—Ö.</span>';
                return;
            }
            
            const apiTags = tags.join('+');
            const randomPid = Math.floor(Math.random() * 6); 
            const url = `${BASE_URL}&limit=10&tags=${apiTags}&pid=${randomPid}&s=post&q=index`;
            
            try {
                const res = await fetch(url);
                const text = await res.text();
                const parser = new DOMParser();
                const posts = parser.parseFromString(text, "text/xml").getElementsByTagName('post');
                
                const similarPosts = Array.from(posts).map(p => {
                    const fileUrl = p.getAttribute('file_url');
                    const ext = fileUrl.split('.').pop().toLowerCase();
                    const isVideo = ext === 'mp4' || ext === 'webm';
                    const sampleUrl = p.getAttribute('sample_url') || fileUrl;
                    const previewUrl = p.getAttribute('preview_url');
                    let gridImage = sampleUrl;
                    if(isVideo) gridImage = previewUrl || sampleUrl; 

                    return {
                        id: p.getAttribute('id'),
                        fileUrl: fileUrl,
                        sampleUrl: sampleUrl,
                        gridUrl: gridImage, 
                        type: isVideo ? 'video' : 'image',
                        score: p.getAttribute('score'),
                        tags: p.getAttribute('tags')
                    };
                }).filter(p => p.id !== mainPost.id);
                
                renderSimilarPosts(similarPosts);

            } catch (e) {
                console.error("‚ùå Error fetching similar posts:", e);
                container.innerHTML = '<span class="text-red-400 text-sm">–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø–æ—Ö–æ–∂–∏—Ö –ø–æ—Å—Ç–æ–≤.</span>';
            }
        }

        function renderSimilarPosts(posts) {
            const container = document.getElementById('similar-posts-grid');
            container.innerHTML = '';
            
            if (posts.length === 0) {
                container.innerHTML = '<span class="text-slate-500 text-sm">–ü–æ—Ö–æ–∂–∏—Ö –ø–æ—Å—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</span>';
                return;
            }
            
            state.similarPosts = posts;

            posts.forEach((post, index) => {
                const el = document.createElement('div');
                el.className = 'flex-shrink-0 card w-24 h-24 overflow-hidden relative cursor-pointer active:scale-95 transition group';
                el.onclick = () => openModal(index, 'similar'); 

                let mediaHtml = '';
                const imgTag = `<img src="${post.gridUrl}" onerror="this.onerror=null;this.src='https://placehold.co/300x400/1e293b/94a3b8?text=Load+Error'" class="w-full h-full object-cover bg-slate-800 transition duration-300 group-hover:scale-105" loading="lazy">`;
                
                if (post.type === 'video') {
                    mediaHtml = `
                        <div class="relative w-full h-full">${imgTag}
                            <div class="absolute inset-0 flex items-center justify-center bg-black/30">
                                <i data-lucide="play" class="w-4 h-4 text-white fill-white"></i>
                            </div>
                        </div>`;
                } else {
                    mediaHtml = imgTag;
                }
                
                el.innerHTML = `
                    <div class="relative w-full h-full">
                        ${mediaHtml}
                        <span class="absolute top-1 right-1 bg-pink-600 text-white text-[8px] font-bold px-1 py-0.5 rounded shadow">SIMILAR</span>
                    </div>`;
                container.appendChild(el);
            });
            lucide.createIcons();
        }


        // --- UTILS (–Ω–µ–∏–∑–º–µ–Ω–Ω—ã) ---
        function toggleHD() {
            state.isHD = !state.isHD;
            const btn = document.getElementById('hd-btn');
            if (state.isHD) { btn.classList.add('hd-active'); btn.innerText = 'HD ON'; } 
            else { btn.classList.remove('hd-active'); btn.innerText = 'HD OFF'; }
            if(!document.getElementById('modal').classList.contains('hidden')) loadModalContent();
        }

        function toggleBlacklistUI() {
            const ui = document.getElementById('blacklist-ui');
            const btn = document.getElementById('btn-blacklist');
            state.blacklistVisible = !state.blacklistVisible;
            ui.classList.toggle('h-0-imp', !state.blacklistVisible);
            ui.classList.toggle('py-2', state.blacklistVisible);
            btn.classList.toggle('text-red-500', state.blacklistVisible);
        }
        
        window.addEventListener('scroll', () => {
            if(state.viewMode !== 'search') return;
            const { scrollTop, scrollHeight, clientHeight } = document.documentElement;
            if (scrollTop + clientHeight >= scrollHeight - 800) fetchPosts();
        });

        function doLucky() {
            const tags = [
                "genshin_impact", "azur_lane", "arknights", "blue_archive", "league_of_legends", "overwatch", "pokemon", "honkai:_star_rail", 
                "fate/grand_order", "nier:_automata", "valorant", "final_fantasy", "fire_emblem", "resident_evil", "splatoon", 
                "the_legend_of_zelda", "bayonetta", "goddess_of_victory:_nikke", "punishing:_gray_raven", "granblue_fantasy", 
                "world_of_warcraft", "apex_legends", "counter-strike:_global_offensive", "street_fighter", "tekken", "dead_or_alive", 
                "metal_gear_solid", "mass_effect", "dragon_quest", "xenoblade_chronicles", "yugioh", "smite", "dotadota", "elden_ring",
                "boku_no_hero_academia", "one_piece", "naruto", "demon_slayer", "jujutsu_kaisen", "spy_x_family", "attack_on_titan", 
                "re:zero", "konosuba", "hololive", "vtuber", "chainsaw_man", "gundam", "evangelion", "kill_la_kill", "sao", 
                "bleach", "dragon_ball", "sailor_moon", "hatsune_miku", "lovelive!", "k-on!", "touhou", "date_a_live", "high_school_dxd", 
                "monster_musume", "the_idolmaster", "a_certain_magical_index", "code_geass", "gintama", "hunter_x_hunter", 
                "my_dress-up_darling", "lycoris_recoil", "bocchi_the_rock!", "oshi_no_ko", "cyberpunk:_edgerunners", "one_punch_man",
                "swimsuit", "bikini", "thighhighs", "barefoot", "abs", "ass", "breasts", "cleavage", "panties", "solo", "group_sex", 
                "intercourse", "bondage", "blowjob", "ahegao", "futanari", "pussy", "anal", "nipples", "masturbation", "tentacles", 
                "monster", "succubus", "elf", "kemonomimi", "catgirl", "foxgirl", "bunny_girl", "robot_girl", "armor", "weapon", 
                "beach", "school_uniform", "nurse", "maid", "bunny_suit", "gothic_lolita", "lingerie", "tattoo", "piercing", "goggles", 
                "glasses", "cosplay", "stockings", "leotard", "high_heels", "skirt", "jacket", "hoodie", "gloves", "garter_belt",
                "latex", "leather", "fishnets", "dress", "uniform",
                "loli", "shota", "milf", "muscular_male", "dark_skin", "light_skin", "red_hair", "blue_hair", "blonde_hair", 
                "pink_hair", "black_hair", "long_hair", "short_hair", "braids", "ponytail", "twintails", "heterochromia", "pale_skin",
                "large_breasts", "small_breasts", "flat_chest", "pregnant",
                "fantasy", "science_fiction", "medieval", "cyberpunk", "steampunk", "mecha", "space", "cityscape", "landscape",
                "traditional_clothes", "kimono", "cheongsam", "armor", "magic", "weapon", "sword", "gun", "robot", "spaceship"
            ];
            
            const t = tags[Math.floor(Math.random() * tags.length)];
            document.getElementById('typeSelect').value = 'all';
            startNewSearch(t, true);
        }

        function toggleFavCurrent() { if(state.posts[state.currentIndex]) toggleFav(state.posts[state.currentIndex]); }
        function toggleFavFromGrid(e, id) { 
            e.stopPropagation(); 
            const post = state.posts.find(p => p.id === id) || state.favorites.find(p => p.id === id);
            if(post) {
                toggleFav(post);
            } else {
                console.error("‚ùå Post not found for ID:", id);
            }
        }
        
        function updateModalHeart(id) {
            const icon = document.getElementById('modal-heart');
            if(!icon) return;
            const isFav = state.favorites.some(f => f.id === id);
            
            icon.classList.toggle('heart-active', isFav);
            icon.classList.toggle('text-white', !isFav); 
            icon.classList.toggle('fill-none', !isFav);
        }
        
        function setView(mode) {
            const grid = document.getElementById('grid');
            const mainControls = document.getElementById('main-controls');
            const favHeader = document.getElementById('fav-header');
            
            grid.classList.add('hidden');
            mainControls.classList.add('hidden');
            favHeader.classList.add('hidden');
            document.getElementById('bottom-loader').classList.add('hidden');
            document.getElementById('empty-state').classList.add('hidden');
            
            if (mode === 'fav') {
                state.viewMode = 'fav';
                state.cachedSearchResults = [...state.posts]; 

                state.posts = [...state.favorites]; 
                grid.classList.remove('hidden');
                grid.innerHTML = '';
                renderBatch(state.posts, 0); 
                favHeader.classList.remove('hidden');
                document.querySelector('#fav-header h2').innerText = '–ò–∑–±—Ä–∞–Ω–Ω–æ–µ';
                document.getElementById('empty-state').classList.toggle('hidden', state.posts.length > 0);
            } 
            else { 
                state.viewMode = 'search';
                state.posts = [...state.cachedSearchResults];
                
                grid.classList.remove('hidden');
                grid.innerHTML = '';
                renderBatch(state.posts, 0);
                
                mainControls.classList.remove('hidden');
                document.getElementById('empty-state').classList.toggle('hidden', state.posts.length > 0);
                
                if (state.posts.length === 0 && state.hasMore) {
                     fetchPosts();
                }
            }
        }

        async function addAllToFav() {
            if (state.posts.length === 0) {
                window.showMessage("–ù–µ—Ç –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ.", 'red');
                return;
            }
            
            if (!window.isAuthReady || !window.db || !window.currentUserId) {
                 window.showMessage("–ü–æ–¥–æ–∂–¥–∏—Ç–µ, –∏–¥—ë—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase. –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å.", 'red');
                 return;
            }

            let addedCount = 0;
            let skippedCount = 0;
            const promises = state.posts.map(async post => {
                const isFav = state.favorites.some(f => f.id === post.id);
                if (!isFav) {
                    const favDocRef = window.doc(window.db, `artifacts/${window.appId}/users/${window.currentUserId}/favorites`, post.id);
                    const dataToSave = {
                        id: post.id,
                        fileUrl: post.fileUrl,
                        sampleUrl: post.sampleUrl,
                        gridUrl: post.gridUrl,
                        type: post.type,
                        score: post.score,
                        tags: post.tags,
                        timestamp: Date.now() 
                    };
                    await window.setDoc(favDocRef, dataToSave);
                    addedCount++;
                } else {
                    skippedCount++;
                }
            });

            try {
                await Promise.all(promises);
                window.showMessage(`‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ ${addedCount} –Ω–æ–≤—ã—Ö –ø–æ—Å—Ç–æ–≤ (–ü—Ä–æ–ø—É—â–µ–Ω–æ: ${skippedCount}).`, 'green');
            } catch(e) {
                console.error("‚ùå Error adding all to favorites:", e);
                window.showMessage(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ: ${e.message}`, 'red');
            }
        }
    </script>
</body>
</html>

